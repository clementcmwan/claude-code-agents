#!/bin/bash
# new-branch-env - Create a mamba environment for the current git branch
# Usage: new-branch-env [--from-base] [--prefix]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
FROM_BASE=false
USE_PREFIX=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --from-base|-b)
            FROM_BASE=true
            shift
            ;;
        --prefix|-p)
            USE_PREFIX=true
            shift
            ;;
        --help|-h)
            echo "Usage: new-branch-env [OPTIONS]"
            echo ""
            echo "Create a mamba environment for the current git branch."
            echo ""
            echo "Options:"
            echo "  -b, --from-base    Clone from base project env instead of environment.yml"
            echo "  -p, --prefix       Prefix env name with project name (e.g., myproj-feature-x)"
            echo "  -h, --help         Show this help message"
            echo ""
            echo "Examples:"
            echo "  git checkout feature-auth"
            echo "  new-branch-env                # Creates 'feature-auth' env"
            echo "  new-branch-env --prefix       # Creates 'myproj-feature-auth' env"
            echo "  new-branch-env --from-base    # Clone from existing project env"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
done

print_step() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    exit 1
fi

# Get current branch name
BRANCH=$(git branch --show-current)
if [ -z "$BRANCH" ]; then
    print_error "Not on a branch (detached HEAD?)"
    exit 1
fi

# Skip if on main/master
if [[ "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
    print_warning "On $BRANCH branch - use the base project environment instead"
    echo ""
    echo "The main/master branch should use the project's base environment."
    echo "If it doesn't exist, create it with: mamba env create -f environment.yml"
    exit 1
fi

# Get project name from environment.yml
PROJECT_NAME=""
if [ -f "environment.yml" ]; then
    PROJECT_NAME=$(grep -E "^name:" environment.yml | head -1 | sed 's/name:[[:space:]]*//' | tr -d '\r')
fi

# Fallback to directory name
if [ -z "$PROJECT_NAME" ]; then
    PROJECT_NAME=$(basename "$(pwd)")
fi

# Determine environment name
if [ "$USE_PREFIX" = true ]; then
    ENV_NAME="${PROJECT_NAME}-${BRANCH}"
else
    ENV_NAME="$BRANCH"
fi

# Check if environment already exists
if mamba env list | grep -qE "^${ENV_NAME}[[:space:]]"; then
    print_warning "Environment '$ENV_NAME' already exists"
    echo ""
    echo "To activate it:  mamba activate $ENV_NAME"
    echo "To remove it:    mamba env remove -n $ENV_NAME"
    exit 1
fi

echo ""
print_step "Creating environment for branch: $BRANCH"
echo "    Project: $PROJECT_NAME"
echo "    Env name: $ENV_NAME"
echo ""

# Determine how to create the environment
if [ "$FROM_BASE" = true ]; then
    # Clone from base project environment
    if ! mamba env list | grep -qE "^${PROJECT_NAME}[[:space:]]"; then
        print_error "Base environment '$PROJECT_NAME' not found"
        echo "Create it first with: mamba env create -f environment.yml"
        exit 1
    fi

    print_step "Cloning from base environment: $PROJECT_NAME"
    mamba create -n "$ENV_NAME" --clone "$PROJECT_NAME" -y
    print_success "Environment cloned from $PROJECT_NAME"

elif [ -f "environment.yml" ]; then
    # Create from environment.yml with different name
    print_step "Creating from environment.yml..."

    # Create a temporary environment.yml with the new name
    TEMP_ENV=$(mktemp)
    sed "s/^name:.*/name: $ENV_NAME/" environment.yml > "$TEMP_ENV"

    mamba env create -f "$TEMP_ENV" -y
    rm "$TEMP_ENV"
    print_success "Environment created from environment.yml"

elif [ -f "requirements.txt" ]; then
    # Create basic env and install from requirements.txt
    print_step "Creating environment and installing from requirements.txt..."

    # Detect Python version from existing env or default
    PYTHON_VERSION="3.11"
    if [ -n "$PROJECT_NAME" ] && mamba env list | grep -qE "^${PROJECT_NAME}[[:space:]]"; then
        DETECTED_PY=$(mamba run -n "$PROJECT_NAME" python --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+' | head -1)
        if [ -n "$DETECTED_PY" ]; then
            PYTHON_VERSION="$DETECTED_PY"
        fi
    fi

    mamba create -n "$ENV_NAME" python="$PYTHON_VERSION" -y -q
    mamba run -n "$ENV_NAME" pip install -r requirements.txt -q
    print_success "Environment created with requirements.txt"

else
    print_error "No environment.yml or requirements.txt found"
    echo ""
    echo "Create an environment.yml first, or use --from-base to clone"
    echo "from an existing project environment."
    exit 1
fi

# Register Jupyter kernel
print_step "Registering Jupyter kernel..."
mamba run -n "$ENV_NAME" python -m ipykernel install --user \
    --name="$ENV_NAME" \
    --display-name="Python ($ENV_NAME)" > /dev/null 2>&1 || true
print_success "Jupyter kernel registered"

# Summary
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
print_success "Environment '$ENV_NAME' created for branch '$BRANCH'"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "To activate:"
echo "    mamba activate $ENV_NAME"
echo ""
echo "When done with this branch, clean up with:"
echo "    cleanup-ds-env"
echo ""
