#!/bin/bash
# Pre-commit hook: Ensures code is clean, validated, and changes are minimal
# Install: cp hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-commit checks..."
echo ""

# Get staged Python files
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

# Get staged SQL files
STAGED_SQL=$(git diff --cached --name-only --diff-filter=ACM | grep -iE '\.(sql|ddl|dml)$' || true)

# 1. Check diff size (encourage minimal changes)
LINES_ADDED=$(git diff --cached --numstat | awk '{sum += $1} END {print sum+0}')
LINES_REMOVED=$(git diff --cached --numstat | awk '{sum += $2} END {print sum+0}')
FILES_CHANGED=$(git diff --cached --name-only | wc -l | tr -d ' ')

echo -e "${YELLOW}Changes:${NC} +${LINES_ADDED} -${LINES_REMOVED} lines across ${FILES_CHANGED} files"

if [ "$LINES_ADDED" -gt 500 ]; then
    echo -e "${YELLOW}Warning:${NC} Large commit (${LINES_ADDED}+ lines). Consider splitting into smaller commits."
fi
echo ""

# 2. Check for debug statements
echo "Checking for debug statements..."
if [ -n "$STAGED_PY" ]; then
    DEBUG_PATTERNS="breakpoint()|import pdb|pdb.set_trace()|import ipdb|ipdb.set_trace()"

    for file in $STAGED_PY; do
        if git diff --cached "$file" | grep -E "^\+" | grep -qE "$DEBUG_PATTERNS"; then
            echo -e "${RED}Error:${NC} Debug statement found in $file"
            echo "Remove breakpoint()/pdb/ipdb before committing."
            exit 1
        fi
    done
fi
echo -e "${GREEN}✓${NC} No debug statements"

# 3. Check for print statements (warning only)
if [ -n "$STAGED_PY" ]; then
    PRINT_COUNT=0
    for file in $STAGED_PY; do
        COUNT=$(git diff --cached "$file" | grep -E "^\+.*print\(" | wc -l | tr -d ' ')
        PRINT_COUNT=$((PRINT_COUNT + COUNT))
    done

    if [ "$PRINT_COUNT" -gt 0 ]; then
        echo -e "${YELLOW}Warning:${NC} ${PRINT_COUNT} print() statements added. Consider using logging instead."
    fi
fi

# 4. Check for secrets/credentials
echo "Checking for secrets..."
SECRET_PATTERNS="password\s*=|api_key\s*=|secret\s*=|token\s*=|AWS_ACCESS_KEY|AWS_SECRET|PRIVATE_KEY"

for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if git diff --cached "$file" | grep -E "^\+" | grep -iqE "$SECRET_PATTERNS"; then
        echo -e "${RED}Error:${NC} Possible secret/credential in $file"
        echo "Use environment variables instead of hardcoding secrets."
        exit 1
    fi
done
echo -e "${GREEN}✓${NC} No secrets detected"

# 5. Check for large files
echo "Checking file sizes..."
MAX_SIZE=5242880  # 5MB

for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" | tr -d ' ')
        if [ "$SIZE" -gt "$MAX_SIZE" ]; then
            SIZE_MB=$((SIZE / 1048576))
            echo -e "${RED}Error:${NC} $file is ${SIZE_MB}MB (max 5MB)"
            echo "Add large files to .gitignore or use Git LFS."
            exit 1
        fi
    fi
done
echo -e "${GREEN}✓${NC} No large files"

# 6. Python syntax check
if [ -n "$STAGED_PY" ]; then
    echo "Checking Python syntax..."
    for file in $STAGED_PY; do
        if [ -f "$file" ]; then
            python3 -m py_compile "$file" 2>/dev/null || {
                echo -e "${RED}Error:${NC} Syntax error in $file"
                exit 1
            }
        fi
    done
    echo -e "${GREEN}✓${NC} Python syntax valid"
fi

# 7. Black formatting (auto-fix)
if [ -n "$STAGED_PY" ] && command -v black &> /dev/null; then
    echo "Formatting code (black)..."
    FORMATTED=""
    for file in $STAGED_PY; do
        if [ -f "$file" ]; then
            if ! black --check --quiet "$file" 2>/dev/null; then
                black --quiet "$file"
                git add "$file"
                FORMATTED="$FORMATTED $file"
            fi
        fi
    done

    if [ -n "$FORMATTED" ]; then
        echo -e "${GREEN}✓${NC} Auto-formatted:$FORMATTED"
    else
        echo -e "${GREEN}✓${NC} Formatting already correct"
    fi
fi

# 8. SQL formatting (auto-fix with sqlfluff)
if [ -n "$STAGED_SQL" ] && command -v sqlfluff &> /dev/null; then
    echo "Formatting SQL (sqlfluff)..."
    FORMATTED_SQL=""

    # Use project .sqlfluff if exists, otherwise use .claude/.sqlfluff
    SQLFLUFF_CONFIG=""
    if [ -f ".sqlfluff" ]; then
        SQLFLUFF_CONFIG=""
    elif [ -f ".claude/.sqlfluff" ]; then
        SQLFLUFF_CONFIG="--config .claude/.sqlfluff"
    fi

    for file in $STAGED_SQL; do
        if [ -f "$file" ]; then
            if ! sqlfluff lint $SQLFLUFF_CONFIG "$file" --quiet 2>/dev/null; then
                sqlfluff fix $SQLFLUFF_CONFIG "$file" --quiet 2>/dev/null || true
                git add "$file"
                FORMATTED_SQL="$FORMATTED_SQL $file"
            fi
        fi
    done

    if [ -n "$FORMATTED_SQL" ]; then
        echo -e "${GREEN}✓${NC} Auto-formatted SQL:$FORMATTED_SQL"
    else
        echo -e "${GREEN}✓${NC} SQL formatting already correct"
    fi
elif [ -n "$STAGED_SQL" ]; then
    echo -e "${YELLOW}Note:${NC} sqlfluff not installed. Install with: pip install sqlfluff"
fi

# 9. Auto-fix unused imports/variables (if autoflake installed)
if [ -n "$STAGED_PY" ] && command -v autoflake &> /dev/null; then
    echo "Removing unused imports (autoflake)..."
    for file in $STAGED_PY; do
        if [ -f "$file" ]; then
            autoflake --in-place --remove-all-unused-imports --remove-unused-variables "$file"
            git add "$file"
        fi
    done
    echo -e "${GREEN}✓${NC} Unused imports/variables removed"
fi

# 10. Flake8 linting (warnings only - can't auto-fix all issues)
if [ -n "$STAGED_PY" ] && command -v flake8 &> /dev/null; then
    echo "Checking linting (flake8)..."
    LINT_ERRORS=""
    for file in $STAGED_PY; do
        if [ -f "$file" ]; then
            ERRORS=$(flake8 --max-line-length=100 --ignore=E501,W503,F401,F841 "$file" 2>/dev/null || true)
            if [ -n "$ERRORS" ]; then
                LINT_ERRORS="$LINT_ERRORS$ERRORS\n"
            fi
        fi
    done

    if [ -n "$LINT_ERRORS" ]; then
        echo -e "${YELLOW}Warning:${NC} Linting issues (manual fix needed):"
        echo -e "$LINT_ERRORS"
    else
        echo -e "${GREEN}✓${NC} Linting passed"
    fi
fi

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
