#!/bin/bash
# commit-msg hook: Validates commit message follows Conventional Commits format
# https://www.conventionalcommits.org/en/v1.0.0/
# Install: cp hooks/commit-msg .git/hooks/ && chmod +x .git/hooks/commit-msg

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Conventional Commits regex pattern
# Format: <type>[optional scope][!]: <description>
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9_-]+\))?(!)?: .{1,}"

# Get first line (subject)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# Validate format
if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo ""
    echo -e "${RED}Error:${NC} Commit message does not follow Conventional Commits format."
    echo ""
    echo -e "${YELLOW}Your message:${NC}"
    echo "  $FIRST_LINE"
    echo ""
    echo -e "${CYAN}Expected format:${NC}"
    echo "  <type>[optional scope]: <description>"
    echo ""
    echo -e "${CYAN}Valid types:${NC}"
    echo "  feat     - A new feature"
    echo "  fix      - A bug fix"
    echo "  docs     - Documentation only changes"
    echo "  style    - Code style changes (formatting, semicolons, etc)"
    echo "  refactor - Code change that neither fixes a bug nor adds a feature"
    echo "  perf     - Performance improvement"
    echo "  test     - Adding or correcting tests"
    echo "  build    - Changes to build system or dependencies"
    echo "  ci       - Changes to CI configuration"
    echo "  chore    - Other changes that don't modify src or test files"
    echo "  revert   - Reverts a previous commit"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  feat: add user authentication"
    echo "  fix(api): resolve null pointer exception"
    echo "  docs: update README with new API endpoints"
    echo "  feat!: redesign user API (breaking change)"
    echo "  refactor(parser): simplify token handling"
    echo ""
    echo -e "${CYAN}For breaking changes, add ! after type/scope:${NC}"
    echo "  feat!: remove deprecated endpoints"
    echo "  feat(api)!: change response format"
    echo ""
    exit 1
fi

# Check description length (should be concise, warn if > 72 chars)
DESCRIPTION_LENGTH=${#FIRST_LINE}
if [ "$DESCRIPTION_LENGTH" -gt 72 ]; then
    echo -e "${YELLOW}Warning:${NC} Subject line is $DESCRIPTION_LENGTH chars (recommended: ≤72)"
fi

# Check description doesn't end with period
if echo "$FIRST_LINE" | grep -qE "\.$"; then
    echo -e "${YELLOW}Warning:${NC} Subject line should not end with a period"
fi

# Check description starts with lowercase (after the colon)
DESCRIPTION=$(echo "$FIRST_LINE" | sed 's/^[^:]*: //')
if echo "$DESCRIPTION" | grep -qE "^[A-Z]"; then
    echo -e "${YELLOW}Warning:${NC} Description should start with lowercase letter"
fi

echo -e "${GREEN}✓${NC} Commit message follows Conventional Commits format"
exit 0
