#!/bin/bash
# install-ds-hooks - Install git hooks for data science project cleanup
# Usage: install-ds-hooks [project-dir]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
TARGET_DIR="${1:-.}"

print_info() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Resolve target directory
TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

# Check if target is a git repository
if [ ! -d "$TARGET_DIR/.git" ]; then
    print_error "Not a git repository: $TARGET_DIR"
    exit 1
fi

HOOKS_DIR="$TARGET_DIR/.git/hooks"

# Install post-merge hook
print_info "Installing post-merge hook..."

if [ -f "$HOOKS_DIR/post-merge" ]; then
    # Check if it's our hook or a different one
    if grep -q "cleanup-ds-env" "$HOOKS_DIR/post-merge" 2>/dev/null; then
        print_info "post-merge hook already installed, updating..."
    else
        # Backup existing hook
        cp "$HOOKS_DIR/post-merge" "$HOOKS_DIR/post-merge.backup"
        print_info "Backed up existing post-merge hook to post-merge.backup"
    fi
fi

cp "$SCRIPT_DIR/hooks/post-merge" "$HOOKS_DIR/post-merge"
chmod +x "$HOOKS_DIR/post-merge"
print_success "post-merge hook installed"

# Ensure cleanup-ds-env is executable
if [ -f "$SCRIPT_DIR/cleanup-ds-env" ]; then
    chmod +x "$SCRIPT_DIR/cleanup-ds-env"
fi

echo ""
print_success "Git hooks installed for: $TARGET_DIR"
echo ""
echo "The post-merge hook will notify you of stale environments after:"
echo "  • git pull"
echo "  • git merge"
echo ""
echo "To manually clean up stale environments, run:"
echo "  cleanup-ds-env --dry-run    # Preview"
echo "  cleanup-ds-env              # Interactive cleanup"
echo "  cleanup-ds-env --force      # Remove without confirmation"
